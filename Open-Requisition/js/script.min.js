const crud=new Firebase("https://adminoxxoparts.firebaseio.com/Oxxo/Requisitions/"),parts=new Firebase("https://adminoxxoparts.firebaseio.com/Oxxo/Parts/"),url_get=localStorage.getItem("open_requisition"),imgUser=localStorage.getItem("Image"),nameUser=localStorage.getItem("Name"),privUSer=localStorage.getItem("Priv"),emailUser=localStorage.getItem("Email"),Token=localStorage.getItem("TokenAccess"),date=new Date,d=document,c=console.log,btn_car_send=d.getElementById("btn_car_send"),acept=d.getElementById("acept"),decline=d.getElementById("decline");window.onload=function(){1==privUSer?$(".user").hide():2==privUSer?($(".admin").hide(),$("#decline").hide(),$("#acept").hide()):(window.localStorage.clear(),location.href="../"),$("#imgUser").attr("src",imgUser),$("#nameUser").html(nameUser),$("#emailUser").html(emailUser)},crud.child(url_get).on("child_added",function(a){$("#tabla").append(carga(a.key(),a.val()))}),crud.on("child_removed",function(a){$("."+a.key()).hide(2e3)}),crud.child(url_get).on("child_changed",function(){if(null===localStorage.getItem("fin")||localStorage.getItem("fin")===void 0||""===localStorage.getItem("fin"));else{if("1"==$("#statusFinal").val())var b=4;else var b=1;$.ajax({url:crud.child(url_get)+".json",type:"PATCH",data:JSON.stringify({Status:b}),success(){localStorage.removeItem("fin"),swal({title:"Requisicion aceptada!",text:".",type:"success",showCancelButton:!1,showConfirmButton:!1,timer:4e3,allowEscapeKey:!1},function(){location.href="../Requisitions"})}})}});function carga(){var a={};crud.child(url_get).on("value",function(b){a=b.val();var e="",i=0;$.each(a,function(k,l){l.namePart===void 0||null===l.namePart||(i++,e+="<input class=\"Have\" value=\""+k+","+l.statusChange+","+l.Parts+","+l.Quantity+"\" type=\"hidden\" readonly/>",e+="<thead class=\""+k+"\">",e+="<tr>",e+="<th>Estatus</th>",e+="<th>Nombre & Modelo</th>",e+="<th style=\"padding-right:220px !important\">CR</th>",e+="<th>Imagen</th>",e+="</tr>",e+="</thead>",e+="<tbody class=\""+k+"\">",e+="<tr>",1===l.statusChange?status="<span class=\"label bg-green\">Activo</span> ":2===l.statusChange?status="<span class=\"label bg-orange\">Sin existencia</span> ":3===l.statusChange?status="<span class=\"label bg-blue\">Entregado</span>":4===l.statusChange?status="<span class=\"label bg-red\">Pendiente</span>":5===l.statusChange?status="<span class=\"label bg-black\">Declinada</span>":6===l.statusChange&&(status="<span class=\"label bg-red\">Pendiente</span><br><span class=\"label bg-green\">Activo</span> "),e+="<td style=\"font-size:18px;\">"+status+"</td>",e+="<td><p>"+l.namePart+"</p><p><b>"+l.modelPart+"</b></p></td>",e+="<td><div class=\"col-md-12 col-xs-12\" ><div class=\"input-group\" ><span class=\"input-group-addon\" ><i class=\"material-icons\" > store</i> </span> <div class=\"form-line\" ><p>"+l.Shops+"</p></div> </div> </div></td>",e+=""==l.imagePart?"<td><h5>Articulo sin imagen</h5><br><div class=\"col-md-12 col-xs-12\" ><div class=\"input-group\" ><span class=\"input-group-addon\" ><i class=\"material-icons\" > format_list_numbered</i> </span> <div class=\"form-line\" style=\"padding-top: 10px;\">"+l.Quantity+"</div> </div> </div></td>":"<td><img data-src="+l.imagePart+" class=\"lazy\" width=\"160px\" alt=\""+l.modelPart+"\"><br><label for=\"quantity"+k+"\"><b>Cantidad:</b></label><div class=\"col-md-12 col-xs-12\" ><div class=\"input-group\" ><span class=\"input-group-addon\" ><i class=\"material-icons\" > format_list_numbered</i> </span> <div class=\"form-line\" style=\"padding-top: 10px;\">"+l.Quantity+"</div> </div> </div></td>",e+="<td>"+""+"</td>",e+="</tr>",e+="</tbody>")}),$("#tabla").html(e),$(".c_noti").html(i),$(".lazy").lazy()})}parts.on("value",a=>{var b={};b=a.val(),$.each(b,function(e,f){$(".Have").each(function(){var g=$(this).val(),h=g.split(",");0<f.Stock&&e===h[2]&&2==h[1]?1==h[1]||$.ajax({url:crud.child(url_get)+"/"+h[0]+"/.json",type:"PATCH",data:JSON.stringify({statusChange:1}),success(){}}):0>=f.Stock&&e===h[2]&&1==h[1]?2==h[1]||$.ajax({url:crud.child(url_get)+"/"+h[0]+"/.json",type:"PATCH",data:JSON.stringify({statusChange:2}),success(){}}):0<f.Stock&&e===h[2]&&4==h[1]&&(1==h[1]||$.ajax({url:crud.child(url_get)+"/"+h[0]+"/.json",type:"PATCH",data:JSON.stringify({statusChange:6}),success(){}}))})})}),acept.addEventListener("click",()=>{var a=0;$("#acept").hide(),$("#decline").hide(),$(".Have").each(function(){a++;var b=$(this).val(),e=b.split(",");if(2==e[1]){var f=4;$("#statusFinal").val(1)}else if(3==e[1]);else{var f=3;$.ajax({url:parts+"/"+e[2]+"/Stock/.json",type:"GET",success(g){if(parseFloat(e[3])>parseFloat(g)){$("#statusFinal").val(1);var i=e[3]-parseFloat(g);$.ajax({url:crud.child(url_get)+"/"+e[0]+".json",type:"PATCH",data:JSON.stringify({Quantity:i,statusChange:4}),success(){$("#statusFinal").val(1)}}),$.ajax({url:parts+"/"+e[2]+".json",type:"PATCH",data:JSON.stringify({Stock:0}),success(){}})}else{var i=parseFloat(g)-e[3];$.ajax({url:parts+"/"+e[2]+".json",type:"PATCH",data:JSON.stringify({Stock:i}),success(){}})}}})}3==e[1]||$.ajax({url:crud.child(url_get)+"/"+e[0]+".json",type:"PATCH",data:JSON.stringify({statusChange:f}),success(){}})}),0<a&&localStorage.setItem("fin",1)}),decline.addEventListener("click",()=>{$("#acept").hide(),$("#decline").hide(),$(".Have").each(function(){var a=$(this).val(),b=a.split(",");$.ajax({url:crud.child(url_get)+"/"+b[0]+".json",type:"PATCH",data:JSON.stringify({statusChange:5}),success(){}})}),$.ajax({url:crud.child(url_get)+".json",type:"PATCH",data:JSON.stringify({Status:3}),success(){swal({title:"Requisicion declinada!",text:".",type:"warning",showCancelButton:!1,showConfirmButton:!1,timer:4e3,allowEscapeKey:!1},function(){location.href="../Requisitions"})}})});